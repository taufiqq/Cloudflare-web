<!-- public/receiver.html -->
<!DOCTYPE html>
<html>
<head>
    <title>WebRTC Receiver</title>
    <style>
        body { font-family: sans-serif; background-color: #eef; padding: 20px; }
        #remoteVideo { width: 640px; height: 480px; border: 1px solid black; background-color: #333; }
        #status { margin-top: 20px; padding: 10px; background-color: #fff; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>WebRTC Penerima</h1>
    <video id="remoteVideo" autoplay playsinline></video>
    <div id="status">Menunggu untuk memulai...</div>

    <script>
        const WORKER_URL = 'signals'; // <-- GANTI DENGAN URL WORKER ANDA
        const remoteVideo = document.getElementById('remoteVideo');
        const statusDiv = document.getElementById('status');
        
        const pcConfig = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };
        
        const pc = new RTCPeerConnection(pcConfig);
        let pollingInterval;
        let processedSenderCandidates = 0;

        async function joinSession() {
            const params = new URLSearchParams(window.location.search);
            const sessionId = params.get('id');

            if (!sessionId) {
                statusDiv.textContent = 'Error: ID Sesi tidak ditemukan di URL. (Contoh: receiver.html?id=xxxx)';
                return;
            }
            
            statusDiv.textContent = `Bergabung dengan sesi ${sessionId}. Polling untuk penawaran...`;

            // Saat track video dari pengirim datang, tampilkan di elemen <video>
            pc.ontrack = event => {
                statusDiv.textContent = 'Track video diterima! Menampilkan stream...';
                if (remoteVideo.srcObject !== event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                }
            };
            
            // Siapkan untuk pertukaran ICE candidate
            pc.onicecandidate = event => {
                if (event.candidate) {
                    console.log('Mengirim kandidat dari Penerima:', event.candidate);
                    fetch(`${WORKER_URL}/session/${sessionId}/candidate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ candidate: event.candidate, type: 'receiver' })
                    });
                }
            };

            // Mulai polling untuk mendapatkan penawaran dan kandidat dari pengirim
            pollingInterval = setInterval(async () => {
                const response = await fetch(`${WORKER_URL}/session/${sessionId}`);
                if (!response.ok) return;
                const sessionData = await response.json();
                
                // Jika penawaran sudah ada dan belum diproses
                if (sessionData.offer && !pc.currentRemoteDescription) {
                    statusDiv.textContent = 'Penawaran diterima. Membuat jawaban...';
                    const offer = JSON.parse(sessionData.offer);
                    await pc.setRemoteDescription(new RTCSessionDescription(offer));
                    
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);

                    statusDiv.textContent = 'Jawaban dibuat. Mengirim ke server...';
                    await fetch(`${WORKER_URL}/session/${sessionId}/answer`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ answer: pc.localDescription })
                    });
                }

                // Proses kandidat baru dari pengirim
                const senderCandidates = JSON.parse(sessionData.sender_candidates);
                if (senderCandidates.length > processedSenderCandidates) {
                    for (let i = processedSenderCandidates; i < senderCandidates.length; i++) {
                         console.log('Menerima kandidat dari Pengirim:', senderCandidates[i]);
                        await pc.addIceCandidate(new RTCIceCandidate(senderCandidates[i]));
                    }
                    processedSenderCandidates = senderCandidates.length;
                }

            }, 2000); // Polling setiap 2 detik
        }

        pc.onconnectionstatechange = () => {
            statusDiv.textContent = `Status Koneksi: ${pc.connectionState}`;
             if (pc.connectionState === 'connected') {
                clearInterval(pollingInterval); // Hentikan polling jika sudah terhubung
                statusDiv.textContent = 'Terhubung! Menerima stream.';
            }
        };

        joinSession();
    </script>
</body>
</html>