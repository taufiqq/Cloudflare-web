<!-- public/sender.html -->
<!DOCTYPE html>
<html>
<head>
    <title>WebRTC Sender</title>
    <style>body { font-family: sans-serif; background-color: #f0f0f0; padding: 20px; } #status { margin-top: 20px; padding: 10px; background-color: #fff; border-radius: 5px; }</style>
</head>
<body>
    <h1>WebRTC Pengirim</h1>
    <div id="status">Menunggu untuk memulai...</div>
    <p>ID Sesi: <strong id="sessionId"></strong></p>
    <p>Bagikan link ini ke penerima: <a id="receiverLink" href="#" target="_blank"></a></p>

    <script>
        const WORKER_URL = 'signals'; // <-- GANTI DENGAN URL WORKER ANDA
        const statusDiv = document.getElementById('status');
        const sessionIdEl = document.getElementById('sessionId');
        const receiverLinkEl = document.getElementById('receiverLink');

        const pcConfig = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] // STUN server publik
        };

        const pc = new RTCPeerConnection(pcConfig);
        let localStream;
        let pollingInterval;
        let processedReceiverCandidates = 0;

        async function start() {
            statusDiv.textContent = 'Meminta akses kamera...';
            try {
                // Konfigurasi media: 480p, 24fps, tanpa audio
                const constraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        frameRate: { ideal: 24 }
                    },
                    audio: false
                };
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                statusDiv.textContent = 'Kamera aktif. Menambahkan track video...';

                // Tambahkan track video ke koneksi
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
                
                // Siapkan untuk pertukaran ICE candidate
                pc.onicecandidate = event => {
                    if (event.candidate) {
                        console.log('Mengirim kandidat dari Pengirim:', event.candidate);
                        fetch(`${WORKER_URL}/session/${sessionIdEl.textContent}/candidate`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ candidate: event.candidate, type: 'sender' })
                        });
                    }
                };

                // Buat penawaran (offer)
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                statusDiv.textContent = 'Penawaran dibuat. Mengirim ke server...';

                // Kirim penawaran ke worker untuk membuat sesi baru
                const response = await fetch(`${WORKER_URL}/session`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ offer: pc.localDescription })
                });

                const { sessionId } = await response.json();
                sessionIdEl.textContent = sessionId;

                // Buat link untuk penerima
                const receiverUrl = `${window.location.origin}${window.location.pathname.replace('sender.html', 'receiver.html')}?id=${sessionId}`;
                receiverLinkEl.href = receiverUrl;
                receiverLinkEl.textContent = receiverUrl;

                statusDiv.textContent = `Sesi dibuat. ID: ${sessionId}. Menunggu jawaban dari penerima...`;

                // Mulai polling untuk mendapatkan jawaban dan kandidat dari penerima
                pollingInterval = setInterval(pollForAnswer, 2000);

            } catch (e) {
                statusDiv.textContent = `Error: ${e.message}`;
                console.error(e);
            }
        }

        async function pollForAnswer() {
            if (!sessionIdEl.textContent) return;

            const response = await fetch(`${WORKER_URL}/session/${sessionIdEl.textContent}`);
            const sessionData = await response.json();

            // Jika jawaban sudah ada dan belum diproses
            if (sessionData.answer && !pc.currentRemoteDescription) {
                statusDiv.textContent = 'Jawaban diterima. Mengatur remote description...';
                const answer = JSON.parse(sessionData.answer);
                await pc.setRemoteDescription(new RTCSessionDescription(answer));
                statusDiv.textContent = 'Koneksi sedang dibangun...';
            }

            // Proses kandidat baru dari penerima
            const receiverCandidates = JSON.parse(sessionData.receiver_candidates);
            if (receiverCandidates.length > processedReceiverCandidates) {
                for (let i = processedReceiverCandidates; i < receiverCandidates.length; i++) {
                    console.log('Menerima kandidat dari Penerima:', receiverCandidates[i]);
                    await pc.addIceCandidate(new RTCIceCandidate(receiverCandidates[i]));
                }
                processedReceiverCandidates = receiverCandidates.length;
            }
        }
        
        pc.onconnectionstatechange = () => {
            statusDiv.textContent = `Status Koneksi: ${pc.connectionState}`;
            if (pc.connectionState === 'connected') {
                clearInterval(pollingInterval); // Hentikan polling jika sudah terhubung
                statusDiv.textContent = 'Terhubung! Streaming sedang berlangsung.';
            }
        };

        start();
    </script>
</body>
</html>